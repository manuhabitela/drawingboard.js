/* drawingboard.js v0.1.0 - https://github.com/Leimi/drawingboard.js
* Copyright (c) 2013 Emmanuel Pelletier 
* Licensed MIT */
window.DrawingBoard={},DrawingBoard.Board=function(a,b){var c='<div class="drawing-board-controls"></div><div class="drawing-board-canvas-wrapper"><canvas class="drawing-board-canvas"></canvas><div class="drawing-board-cursor hidden"></div></div>';this.opts=$.extend({controls:["Color","Size","Navigation"],background:"#ffffff",localStorage:!1,color:"#000000",size:3,droppable:!0},b),this.ev=new DrawingBoard.Utils.MicroEvent,this.id=a,this.$el=$(document.getElementById(a));if(!this.$el.length)return!1;this.$el.addClass("drawing-board").append(c),this.dom={$canvasWrapper:this.$el.find(".drawing-board-canvas-wrapper"),$canvas:this.$el.find(".drawing-board-canvas"),$cursor:this.$el.find(".drawing-board-cursor"),$controls:this.$el.find(".drawing-board-controls")},this.canvas=this.dom.$canvas.get(0),this.ctx=this.canvas.getContext("2d"),this.initControls(),this.reset({localStorage:!1}),this.restoreLocalStorage(),this.initDropEvents(),this.initDrawEvents()},DrawingBoard.Board.prototype={reset:function(a){a=$.extend({background:this.opts.background,color:this.opts.color,size:this.opts.size,history:!0,localStorage:!0},a);var b=a.background.charAt(0)=="#"&&(a.background.length==7||a.background.length==4)||a.background.substring(0,3)=="rgb",c=this.$el.width()-DrawingBoard.Utils.boxBorderWidth(this.$el)-DrawingBoard.Utils.boxBorderWidth(this.dom.$canvasWrapper,!0,!0),d=this.$el.height()-DrawingBoard.Utils.boxBorderHeight(this.$el)-this.dom.$controls.height()-DrawingBoard.Utils.boxBorderHeight(this.dom.$controls,!1,!0)-DrawingBoard.Utils.boxBorderHeight(this.dom.$canvasWrapper,!0,!0);this.dom.$canvasWrapper.css("width",c+"px"),this.dom.$canvasWrapper.css("height",d+"px"),this.canvas.width=c,this.canvas.height=d,this.ctx.strokeStyle=a.color,this.ctx.lineWidth=a.size,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.ctx.save(),b&&(this.ctx.fillStyle=a.background),this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.restore(),b||this.setImg(this.opts.background),a.localStorage&&this.saveLocalStorage(),this.ev.trigger("board:reset",a)},initControls:function(){this.controls=[];if(!this.opts.controls.length)return!1;for(var a=0;a<this.opts.controls.length;a++){var b=null;if(typeof this.opts.controls[a]=="string")b=new window.DrawingBoard.Control[this.opts.controls[a]](this);else if(typeof this.opts.controls[a]=="object"){for(var c in this.opts.controls[a])break;b=new window.DrawingBoard.Control[c](this,this.opts.controls[a][c])}b&&this.addControl(b)}},addControl:function(a,b,c){if(typeof a!="string"&&(typeof a!="object"||!a instanceof DrawingBoard.Control))return!1;var d=typeof b=="object"?b:{};c=c?c*1:typeof b=="number"?b:null,typeof a=="string"&&(a=new window.DrawingBoard.Control[a](this,d)),c?this.dom.$controls.children().eq(c).before(a.$el):this.dom.$controls.append(a.$el),this.controls||(this.controls=[]),this.controls.push(a)},setImg:function(a){img=new Image,img.onload=$.proxy(function(){this.ctx.drawImage(img,0,0)},this),img.src=a},getImg:function(){return this.canvas.toDataURL("image/png")},downloadImg:function(){var a=this.getImg();a=a.replace("image/png","image/octet-stream"),window.location.href=a},restoreLocalStorage:function(){this.opts.localStorage&&window.localStorage&&localStorage.getItem("drawing-board-image-"+this.id)!==null&&(this.setImg(localStorage.getItem("drawing-board-image-"+this.id)),this.ev.trigger("board:restoreLocalStorage",localStorage.getItem("drawing-board-image-"+this.id)))},saveLocalStorage:function(){this.opts.localStorage&&window.localStorage&&(localStorage.setItem("drawing-board-image-"+this.id,this.getImg()),this.ev.trigger("board:saveLocalStorage",this.getImg()))},initDropEvents:function(){if(!this.opts.droppable)return!1;this.dom.$canvas.on("dragover dragenter drop",function(a){a.stopPropagation(),a.preventDefault()}),this.dom.$canvas.on("drop",$.proxy(this._onCanvasDrop,this))},_onCanvasDrop:function(a){a=a.originalEvent?a.originalEvent:a;var b=a.dataTransfer.files;if(!b||!b.length||b[0].type.indexOf("image")==-1||!window.FileReader)return!1;var c=new FileReader;c.readAsDataURL(b[0]),c.onload=$.proxy(function(a){this.setImg(a.target.result),this.ev.trigger("board:imageDropped",a.target.result),this.ev.trigger("board:userAction")},this)},initDrawEvents:function(){this.isDrawing=!1,this.isMouseHovering=!1,this.coords={},this.coords.old=this.coords.current=this.coords.oldMid={x:0,y:0},this.dom.$canvas.on("mousedown touchstart",$.proxy(function(a){this._onInputStart(a,this._getInputCoords(a))},this)),this.dom.$canvas.on("mousemove touchmove",$.proxy(function(a){this._onInputMove(a,this._getInputCoords(a))},this)),this.dom.$canvas.on("mousemove",$.proxy(function(a){},this)),this.dom.$canvas.on("mouseup touchend",$.proxy(function(a){this._onInputStop(a,this._getInputCoords(a))},this)),this.dom.$canvas.on("mouseover",$.proxy(function(a){this._onMouseOver(a,this._getInputCoords(a))},this)),this.dom.$canvas.on("mouseout",$.proxy(function(a){this._onMouseOut(a,this._getInputCoords(a))},this)),requestAnimationFrame($.proxy(this.draw,this))},draw:function(){if(this.ctx.lineWidth>10&&this.isMouseHovering){this.dom.$cursor.css({width:this.ctx.lineWidth+"px",height:this.ctx.lineWidth+"px"});var a=DrawingBoard.Utils.tpl("translateX({{x}}px) translateY({{y}}px)",{x:this.coords.current.x-this.ctx.lineWidth/2,y:this.coords.current.y-this.ctx.lineWidth/2});this.dom.$cursor.css({transform:a,"-webkit-transform":a,"-ms-transform":a}),this.dom.$cursor.removeClass("drawing-board-utils-hidden")}else this.dom.$cursor.addClass("drawing-board-utils-hidden");if(this.isDrawing){var b=this._getMidInputCoords(this.coords.current);this.ctx.beginPath(),this.ctx.moveTo(b.x,b.y),this.ctx.quadraticCurveTo(this.coords.old.x,this.coords.old.y,this.coords.oldMid.x,this.coords.oldMid.y),this.ctx.stroke(),this.coords.old=this.coords.current,this.coords.oldMid=b}requestAnimationFrame($.proxy(function(){this.draw()},this))},_onInputStart:function(a,b){this.coords.current=this.coords.old=b,this.coords.oldMid=this._getMidInputCoords(b),this.isDrawing=!0,this.ev.trigger("board:startDrawing",{e:a,coords:b}),a.preventDefault()},_onInputMove:function(a,b){this.coords.current=b,this.ev.trigger("board:drawing",{e:a,coords:b}),a.preventDefault()},_onInputStop:function(a,b){this.isDrawing&&(!a.touches||a.touches.length===0)&&(this.isDrawing=!1,this.saveLocalStorage(),this.ev.trigger("board:stopDrawing",{e:a,coords:b}),this.ev.trigger("board:userAction"),a.preventDefault())},_onMouseOver:function(a,b){this.isMouseHovering=!0,this.coords.old=this._getInputCoords(a),this.coords.oldMid=this._getMidInputCoords(this.coords.old),a.which!==1&&(this.isDrawing=!1),this.ev.trigger("board:mouseOver",{e:a,coords:b})},_onMouseOut:function(a,b){this.isMouseHovering=!1,this.ev.trigger("board:mouseOut",{e:a,coords:b})},_getInputCoords:function(a){a=a.originalEvent?a.originalEvent:a;var b,c;return a.touches&&a.touches.length==1?(b=a.touches[0].pageX,c=a.touches[0].pageY):(b=a.pageX,c=a.pageY),{x:b-this.dom.$canvas.offset().left,y:c-this.dom.$canvas.offset().top}},_getMidInputCoords:function(a){return{x:this.coords.old.x+a.x>>1,y:this.coords.old.y+a.y>>1}}},DrawingBoard.Control=function(a,b){return this.board=a,this.opts=$.extend({},this.defaults,b),this.$el=$(document.createElement("div")).addClass("drawing-board-control"),this.name&&this.$el.addClass("drawing-board-control-"+this.name),this.board.ev.bind("board:reset",$.proxy(this.onBoardReset,this)),this.initialize.apply(this,arguments),this},DrawingBoard.Control.prototype={name:"",defaults:{},initialize:function(){},addToBoard:function(){this.board.addControl(this)},onBoardReset:function(a){}},DrawingBoard.Control.extend=function(a,b){var c=this,d;a&&a.hasOwnProperty("constructor")?d=a.constructor:d=function(){return c.apply(this,arguments)},$.extend(d,c,b);var e=function(){this.constructor=d};return e.prototype=c.prototype,d.prototype=new e,a&&$.extend(d.prototype,a),d.__super__=c.prototype,d},DrawingBoard.Control.Color=DrawingBoard.Control.extend({name:"colors",defaults:{compact:!0},initialize:function(){this.initTemplate();var a=this;this.$el.on("click",".drawing-board-control-colors-picker",function(b){a.board.ctx.strokeStyle=$(this).attr("data-color"),a.$el.find(".drawing-board-control-colors-current").css("background-color",$(this).attr("data-color")).attr("data-color",$(this).attr("data-color")),a.opts.compact&&a.$el.find(".drawing-board-control-colors-rainbows").addClass("drawing-board-utils-hidden"),a.board.ev.trigger("color:changed",$(this).attr("data-color")),b.preventDefault()}),this.$el.on("click",".drawing-board-control-colors-current",function(b){a.opts.compact?a.$el.find(".drawing-board-control-colors-rainbows").toggleClass("drawing-board-utils-hidden"):a.board.reset({background:$(this).attr("data-color")}),b.preventDefault()})},initTemplate:function(){var a='<div class="drawing-board-control-inner"><div class="drawing-board-control-colors-current" style="background-color: {{color}}" data-color="{{color}}"></div><div class="drawing-board-control-colors-rainbows">{{rainbows}}</div></div>',b='<div class="drawing-board-control-colors-picker" data-color="{{color}}" style="background-color: {{color}}"></div>',c="";$.each([.75,.5,.25],$.proxy(function(a,d){var e=0,f=null;c+='<div class="drawing-board-control-colors-rainbow">',d==.25&&(f=this._rgba(0,0,0,1)),d==.5&&(f=this._rgba(150,150,150,1)),d==.75&&(f=this._rgba(255,255,255,1)),c+=DrawingBoard.Utils.tpl(b,{color:f.toString()});while(e<=330)c+=DrawingBoard.Utils.tpl(b,{color:this._hsl2Rgba(this._hsl(e-60,1,d)).toString()}),e+=30;c+="</div>"},this)),this.$el.append($(DrawingBoard.Utils.tpl(a,{color:this.board.ctx.strokeStyle,rainbows:c}))),this.opts.compact&&(this.$el.find(".drawing-board-control-colors-rainbows").addClass("drawing-board-utils-hidden"),this.$el.attr("data-drawing-board-compact","1"))},onBoardReset:function(a){this.board.ctx.strokeStyle=this.$el.find(".drawing-board-control-colors-current").attr("data-color")},_rgba:function(a,b,c,d){return{r:a,g:b,b:c,a:d,toString:function(){return"rgba("+a+", "+b+", "+c+", "+d+")"}}},_hsl:function(a,b,c){return{h:a,s:b,l:c,toString:function(){return"hsl("+a+", "+b*100+"%, "+c*100+"%)"}}},_hex2Rgba:function(a){var b=parseInt(a.substring(1),16);return this._rgba(b>>16,b>>8&255,b&255,1)},_hsl2Rgba:function(a){function h(a,b,c){return c<0&&(c+=1),c>1&&(c-=1),c<1/6?a+(b-a)*6*c:c<.5?b:c<2/3?a+(b-a)*(2/3-c)*6:a}var b=a.h/360,c=a.s,d=a.l,e,f,g;if(c===0)e=f=g=d;else{var i=d<.5?d*(1+c):d+c-d*c,j=2*d-i;e=Math.floor(h(j,i,b+1/3)*255),f=Math.floor(h(j,i,b)*255),g=Math.floor(h(j,i,b-1/3)*255)}return this._rgba(e,f,g,1)}}),DrawingBoard.Control.Navigation=DrawingBoard.Control.extend({name:"navigation",defaults:{back:!0,forward:!0,reset:!0},initialize:function(){this.history={values:[],position:0},this.saveHistory();var a="";this.opts.back&&(a+='<button class="drawing-board-control-navigation-back">&larr;</button>'),this.opts.forward&&(a+='<button class="drawing-board-control-navigation-forward">&rarr;</button>'),this.opts.reset&&(a+='<button class="drawing-board-control-navigation-reset">×</button>'),this.$el.append(a),this.opts.back&&this.$el.on("click",".drawing-board-control-navigation-back",$.proxy(function(a){this.goBackInHistory(),a.preventDefault()},this)),this.opts.forward&&this.$el.on("click",".drawing-board-control-navigation-forward",$.proxy(function(a){this.goForthInHistory(),a.preventDefault()},this)),this.opts.reset&&this.$el.on("click",".drawing-board-control-navigation-reset",$.proxy(function(a){this.board.reset(),a.preventDefault()},this)),this.board.ev.bind("board:userAction",$.proxy(this.saveHistory,this))},saveHistory:function(){while(this.history.values.length>30)this.history.values.shift();this.history.position!==0&&this.history.position!==this.history.values.length?(this.history.values=this.history.values.slice(0,this.history.position),this.history.position++):this.history.position=this.history.values.length+1,this.history.values.push(this.board.getImg())},_goThroughHistory:function(a){if(a&&this.history.position==this.history.values.length||!a&&this.history.position==1)return;var b=a?this.history.position+1:this.history.position-1;this.history.values.length&&this.history.values[b-1]!==undefined&&(this.history.position=b,this.board.setImg(this.history.values[this.history.position-1])),this.board.saveLocalStorage()},goBackInHistory:function(){this._goThroughHistory(!1)},goForthInHistory:function(){this._goThroughHistory(!0)},onBoardReset:function(a){a.history&&this.saveHistory()}}),DrawingBoard.Control.Size=DrawingBoard.Control.extend({name:"size",defaults:{type:"list",list:[1,3,6,10,20,30,40,50]},types:["list","range"],initialize:function(){var a=$.inArray(this.opts.type,this.types)>-1?this["_"+this.opts.type+"Template"]():!1;if(!a)return!1;this.val=this.board.opts.size,this.$el.append($(a)),this.$el.attr("data-drawing-board-type",this.opts.type),this.updateView();var b=this;this.opts.type=="range"&&this.$el.on("change",".drawing-board-control-size-input",function(a){b.val=$(this).val(),b.updateView(),b.board.ev.trigger("size:changed",b.val),a.preventDefault()}),this.opts.type=="list"&&(this.$el.on("click",".drawing-board-control-size-list-current",$.proxy(function(a){this.$el.find(".drawing-board-control-size-list").toggleClass("drawing-board-utils-hidden")},this)),this.$el.on("click","[data-size]",function(a){b.val=parseInt($(this).attr("data-size"),0),b.updateView(),b.board.ev.trigger("size:changed",b.val),a.preventDefault()}))},_rangeTemplate:function(){var a='<div class="drawing-board-control-inner"><input type="range" min="1" max="50" value="{{size}}" step="1" class="drawing-board-control-size-input"><span class="drawing-board-control-size-range-current"></span></div>';return DrawingBoard.Utils.tpl(a,{size:this.board.opts.size})},_listTemplate:function(){var a='<div class="drawing-board-control-inner"><div class="drawing-board-control-size-list-current"><span></span></div><ul class="drawing-board-control-size-list">';return $.each(this.opts.list,function(b,c){a+=DrawingBoard.Utils.tpl('<li data-size="{{size}}"><span style="width: {{size}}px; height: {{size}}px; border-radius: {{size}}px;"></span></li>',{size:c})}),a+="</ul></div>",a},onBoardReset:function(a){this.updateView()},updateView:function(){var a=this.val;this.board.ctx.lineWidth=a,this.$el.find(".drawing-board-control-size-range-current, .drawing-board-control-size-list-current span").css({width:a+"px",height:a+"px",borderRadius:a+"px",marginLeft:-1*a/2+"px",marginTop:-1*a/2+"px"});if(this.opts.type=="list"){var b=null;$.each(this.opts.list,function(c,d){if(b===null||Math.abs(d-a)<Math.abs(b-a))b=d}),this.$el.find(".drawing-board-control-size-list").addClass("drawing-board-utils-hidden")}}}),DrawingBoard.Control.Download=DrawingBoard.Control.extend({name:"download",initialize:function(){this.$el.append('<button class="drawing-board-control-download-button">⤓</button>'),this.$el.on("click",".drawing-board-control-download-button",$.proxy(function(a){this.board.downloadImg(),a.preventDefault()},this))}}),DrawingBoard.Utils={},DrawingBoard.Utils.tpl=function(){"use strict";var a="{{",b="}}",c="[a-z0-9_][\\.a-z0-9_]*",d=new RegExp(a+"\\s*("+c+")\\s*"+b,"gi"),e;return function(a,b){return a.replace(d,function(a,c){var d=c.split("."),f=d.length,g=b,h=0;for(;h<f;h++){g=g[d[h]];if(g===e)throw"tim: '"+d[h]+"' not found in "+a;if(h===f-1)return g}})}}(),DrawingBoard.Utils.MicroEvent=function(){},DrawingBoard.Utils.MicroEvent.prototype={bind:function(a,b){this._events=this._events||{},this._events[a]=this._events[a]||[],this._events[a].push(b)},unbind:function(a,b){this._events=this._events||{};if(a in this._events==!1)return;this._events[a].splice(this._events[a].indexOf(b),1)},trigger:function(a){this._events=this._events||{};if(a in this._events==!1)return;for(var b=0;b<this._events[a].length;b++)this._events[a][b].apply(this,Array.prototype.slice.call(arguments,1))}},DrawingBoard.Utils._boxBorderSize=function(a,b,c,d){b=!!b||!0,c=!!c||!1;var e=0,f;d=="width"?(f=["border-left-width","border-right-width"],b&&f.push("padding-left","padding-right"),c&&f.push("margin-left","margin-right")):(f=["border-top-width","border-bottom-width"],b&&f.push("padding-top","padding-bottom"),c&&f.push("margin-top","margin-bottom"));for(var g=f.length-1;g>=0;g--)e+=parseInt(a.css(f[g]).replace("px",""),10);return e},DrawingBoard.Utils.boxBorderWidth=function(a,b,c){return DrawingBoard.Utils._boxBorderSize(a,b,c,"width")},DrawingBoard.Utils.boxBorderHeight=function(a,b,c){return DrawingBoard.Utils._boxBorderSize(a,b,c,"height")},function(){var a=0,b=["ms","moz","webkit","o"];for(var c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b,c){var d=(new Date).getTime(),e=Math.max(0,16-(d-a)),f=window.setTimeout(function(){b(d+e)},e);return a=d+e,f}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}();